<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INFINITI MKT | AI Growth Engine</title>
    
    <!-- Librerías -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        inf: {
                            bg: '#050505',
                            panel: '#111111',
                            purple: '#8b5cf6', // Primary
                            pink: '#ec4899',   // Accent
                            cyan: '#06b6d4',   // Tech
                            text: '#f3f4f6',
                            border: '#27272a'
                        }
                    },
                    animation: {
                        'gradient-x': 'gradient-x 15s ease infinite',
                    },
                    keyframes: {
                        'gradient-x': {
                            '0%, 100%': { 'background-size': '200% 200%', 'background-position': 'left center' },
                            '50%': { 'background-size': '200% 200%', 'background-position': 'right center' },
                        },
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #050505; color: #f3f4f6; overflow: hidden; }
        .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }
        .prose h1, .prose h2, .prose h3 { color: white; font-weight: bold; margin-bottom: 0.5rem; margin-top: 1rem; }
        .prose strong { color: #8b5cf6; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; color: #d1d5db; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #8b5cf6; }
    </style>
</head>
<body class="h-screen w-screen flex font-sans">
    <div id="root" class="w-full h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==========================================
        // CONFIGURACIÓN NEURONAL
        // ==========================================
        const API_URL = "https://marketing-ia-dca462ac6c86.herokuapp.com"; 

        const firebaseConfig = {
            apiKey: "AIzaSyC8Qqq7F1kGvaNlTzL5gRQWTdMBVjuEamQ", 
            authDomain: "abunda-ai.firebaseapp.com",
            projectId: "abunda-ai",
            storageBucket: "abunda-ai.firebasestorage.app",
            messagingSenderId: "G-4XZ8WVKSL1",
            appId: "1:833878539166:web:01a3726d456efd3bbb348f"
        };

        try {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        } catch(e) { console.error("Firebase Error:", e); }

        // ==========================================
        // COMPONENTES DE INTERFAZ
        // ==========================================

        const Sidebar = ({ tab, setTab, onLogout }) => (
            <aside className="w-20 md:w-64 bg-inf-panel border-r border-inf-border flex flex-col transition-all duration-300 z-20">
                <div className="h-20 flex items-center justify-center md:justify-start md:px-6 border-b border-inf-border">
                    <i className="ph ph-infinity text-3xl text-inf-purple mr-0 md:mr-3 animate-pulse"></i>
                    <span className="font-bold text-xl tracking-wider hidden md:block">INFINITI</span>
                </div>

                <nav className="flex-1 py-6 space-y-2 px-2">
                    <MenuBtn icon="ph-squares-four" label="Dashboard" active={tab==='dashboard'} onClick={()=>setTab('dashboard')} />
                    <MenuBtn icon="ph-paint-brush-broad" label="Creative Studio" active={tab==='studio'} onClick={()=>setTab('studio')} />
                    <MenuBtn icon="ph-strategy" label="Estratega GPT" active={tab==='chat'} onClick={()=>setTab('chat')} />
                </nav>

                <div className="p-4 border-t border-inf-border">
                    <button onClick={onLogout} className="flex items-center justify-center md:justify-start w-full text-gray-500 hover:text-red-400 transition gap-3 p-2 rounded-lg hover:bg-white/5">
                        <i className="ph ph-sign-out text-xl"></i>
                        <span className="hidden md:block text-sm font-medium">Desconectar</span>
                    </button>
                </div>
            </aside>
        );

        const MenuBtn = ({ icon, label, active, onClick }) => (
            <button onClick={onClick} className={`w-full flex items-center justify-center md:justify-start gap-3 px-3 py-3 rounded-xl transition-all duration-200 ${active ? 'bg-gradient-to-r from-inf-purple to-indigo-600 text-white shadow-lg shadow-purple-500/20' : 'text-gray-400 hover:text-white hover:bg-white/5'}`}>
                <i className={`ph ${icon} text-xl`}></i>
                <span className="hidden md:block text-sm font-medium">{label}</span>
            </button>
        );

        // --- VISTA 1: DASHBOARD ---
        const DashboardView = () => {
            useEffect(() => {
                const ctx = document.getElementById('mainChart');
                if(ctx) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'],
                            datasets: [{
                                label: 'Engagement',
                                data: [12, 19, 15, 25, 22, 30, 45],
                                borderColor: '#8b5cf6',
                                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                                tension: 0.4, fill: true
                            }]
                        },
                        options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
                    });
                }
            }, []);

            return (
                <div className="p-8 space-y-8 animate-fade-in-up">
                    <h2 className="text-2xl font-bold">Resumen de Impacto</h2>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <StatCard title="Alcance Total" value="1.2M" icon="ph-globe" color="text-inf-cyan" trend="+12%" />
                        <StatCard title="Conversiones" value="4,502" icon="ph-target" color="text-inf-purple" trend="+5.4%" />
                        <StatCard title="ROI Publicitario" value="320%" icon="ph-currency-dollar" color="text-inf-pink" trend="+2.1%" />
                    </div>
                    <div className="glass p-6 rounded-2xl h-80 border border-inf-border">
                        <h3 className="text-sm font-bold text-gray-400 mb-4 uppercase">Tendencia Semanal</h3>
                        <div className="h-64"><canvas id="mainChart"></canvas></div>
                    </div>
                </div>
            );
        };

        const StatCard = ({ title, value, icon, color, trend }) => (
            <div className="glass p-6 rounded-2xl border border-inf-border hover:border-inf-purple/50 transition">
                <div className="flex justify-between items-start mb-4">
                    <div className={`p-3 rounded-xl bg-white/5 ${color}`}><i className={`ph ${icon} text-xl`}></i></div>
                    <span className="text-xs bg-green-500/20 text-green-400 px-2 py-1 rounded-full font-bold">{trend}</span>
                </div>
                <p className="text-gray-400 text-sm">{title}</p>
                <h3 className="text-3xl font-bold text-white">{value}</h3>
            </div>
        );

        // --- VISTA 2: CREATIVE STUDIO (TEXTO + IMAGEN) ---
        const StudioView = () => {
            const [mode, setMode] = useState('text'); // 'text' | 'image'
            const [prompt, setPrompt] = useState('');
            const [result, setResult] = useState(null);
            const [loading, setLoading] = useState(false);

            const handleCreate = async () => {
                if(!prompt.trim()) return;
                setLoading(true);
                setResult(null);

                try {
                    const endpoint = mode === 'text' ? '/api/chat' : '/api/image';
                    const payload = mode === 'text' 
                        ? { message: `ACTÚA COMO: Copywriter experto. CREA: Contenido de marketing sobre "${prompt}". FORMATO: Markdown.`, history: [] }
                        : { prompt: prompt };

                    const res = await fetch(`${API_URL}${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const data = await res.json();
                    
                    if (mode === 'text') setResult(data.response);
                    else setResult({ url: data.url, enhanced: data.enhanced_prompt });

                } catch (e) {
                    alert("Error en el proceso creativo: " + e.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="flex flex-col h-full p-8 gap-6">
                    <div className="glass p-6 rounded-2xl border border-inf-border flex flex-col md:flex-row gap-6">
                        <div className="w-full md:w-1/3 space-y-4">
                            <div className="flex bg-black rounded-lg p-1 border border-inf-border">
                                <button onClick={()=>setMode('text')} className={`flex-1 py-2 text-xs font-bold rounded-md transition ${mode==='text' ? 'bg-inf-purple text-white' : 'text-gray-500 hover:text-white'}`}>TEXTO</button>
                                <button onClick={()=>setMode('image')} className={`flex-1 py-2 text-xs font-bold rounded-md transition ${mode==='image' ? 'bg-inf-pink text-white' : 'text-gray-500 hover:text-white'}`}>IMAGEN (DALL-E)</button>
                            </div>
                            <textarea 
                                value={prompt} onChange={e=>setPrompt(e.target.value)}
                                className="w-full h-32 bg-black/50 border border-inf-border rounded-xl p-4 text-white focus:border-inf-purple outline-none resize-none placeholder:text-gray-600"
                                placeholder={mode === 'text' ? "Describe el post, artículo o guion..." : "Describe la imagen publicitaria que deseas..."}
                            ></textarea>
                            <button onClick={handleCreate} disabled={loading} className={`w-full py-3 rounded-xl font-bold text-white shadow-lg transition flex justify-center items-center gap-2 ${mode==='text' ? 'bg-inf-purple hover:bg-purple-600' : 'bg-inf-pink hover:bg-pink-600'}`}>
                                {loading ? <i className="ph ph-spinner animate-spin"></i> : <i className="ph ph-sparkle"></i>}
                                {mode === 'text' ? 'Generar Copy' : 'Renderizar Arte'}
                            </button>
                        </div>

                        <div className="flex-1 bg-black/30 rounded-xl border border-inf-border p-6 overflow-y-auto flex items-center justify-center min-h-[400px]">
                            {!result && !loading && (
                                <div className="text-center opacity-30">
                                    <i className={`ph ${mode==='text' ? 'ph-pencil-simple' : 'ph-image'} text-6xl mb-2`}></i>
                                    <p>El lienzo está vacío</p>
                                </div>
                            )}
                            {loading && (
                                <div className="text-center">
                                    <div className="w-12 h-12 border-4 border-white border-t-transparent rounded-full animate-spin mb-4 mx-auto"></div>
                                    <p className="text-xs text-inf-cyan animate-pulse">La IA está trabajando...</p>
                                </div>
                            )}
                            {result && mode === 'text' && (
                                <div className="prose prose-invert w-full text-left" dangerouslySetInnerHTML={{__html: marked.parse(result)}}></div>
                            )}
                            {result && mode === 'image' && (
                                <div className="text-center w-full h-full flex flex-col items-center">
                                    <img src={result.url} className="max-h-[500px] rounded-lg shadow-2xl border border-inf-border object-contain" />
                                    <p className="text-[10px] text-gray-500 mt-4 max-w-lg italic">"{result.enhanced}"</p>
                                    <a href={result.url} target="_blank" className="mt-4 px-6 py-2 bg-white text-black rounded-full font-bold text-xs hover:bg-gray-200 transition">Descargar HD</a>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- VISTA 3: CHAT GPT ---
        const ChatView = () => {
            const [messages, setMessages] = useState([{ role: 'ai', content: 'Hola. Soy tu Estratega de Marketing Senior. ¿Qué campaña planeamos hoy?' }]);
            const [input, setInput] = useState("");
            const [loading, setLoading] = useState(false);
            const bottomRef = useRef(null);

            useEffect(() => bottomRef.current?.scrollIntoView({ behavior: 'smooth' }), [messages]);

            const send = async () => {
                if(!input.trim()) return;
                const newMsg = { role: 'user', content: input };
                setMessages(p => [...p, newMsg]);
                setInput(""); setLoading(true);

                try {
                    const res = await fetch(`${API_URL}/api/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: newMsg.content, history: messages })
                    });
                    const data = await res.json();
                    setMessages(p => [...p, { role: 'ai', content: data.response }]);
                } catch(e) {
                    setMessages(p => [...p, { role: 'ai', content: "Error de conexión." }]);
                } finally { setLoading(false); }
            };

            return (
                <div className="flex flex-col h-full bg-inf-bg">
                    <div className="flex-1 overflow-y-auto p-8 space-y-6">
                        {messages.map((m, i) => (
                            <div key={i} className={`flex ${m.role==='user'?'justify-end':'justify-start'}`}>
                                <div className={`max-w-[80%] p-4 rounded-2xl text-sm leading-relaxed shadow-lg ${m.role==='user'?'bg-inf-purple text-white rounded-br-none':'bg-inf-panel border border-inf-border text-gray-300 rounded-bl-none'}`}>
                                    <div dangerouslySetInnerHTML={{__html: marked.parse(m.content)}}></div>
                                </div>
                            </div>
                        ))}
                        {loading && <div className="text-gray-500 text-xs ml-4">Escribiendo estrategia...</div>}
                        <div ref={bottomRef}></div>
                    </div>
                    <div className="p-6 border-t border-inf-border bg-inf-panel">
                        <div className="flex gap-2 max-w-4xl mx-auto">
                            <input type="text" value={input} onChange={e=>setInput(e.target.value)} onKeyPress={e=>e.key==='Enter' && send()} className="flex-1 bg-black/50 border border-inf-border rounded-xl px-4 text-white focus:border-inf-purple outline-none" placeholder="Escribe tu consulta..." />
                            <button onClick={send} className="p-3 bg-inf-purple rounded-xl text-white hover:bg-purple-600 transition"><i className="ph ph-paper-plane-right"></i></button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [tab, setTab] = useState('studio'); // Default tab

            useEffect(() => {
                 firebase.auth().onAuthStateChanged(u => setUser(u || null));
            }, []);

            if (!user) return (
                <div className="h-full flex items-center justify-center bg-inf-bg relative">
                    <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')] opacity-20"></div>
                    <div className="glass p-10 rounded-2xl w-full max-w-md text-center relative z-10 shadow-2xl shadow-purple-900/20">
                        <i className="ph ph-infinity text-6xl text-inf-purple mb-4 inline-block animate-pulse"></i>
                        <h1 className="text-3xl font-bold mb-2">INFINITI <span className="text-inf-purple">MKT</span></h1>
                        <p className="text-gray-500 text-sm mb-8">Intelligence Growth Engine</p>
                        <button onClick={() => {
                            // Simple login simulation/trigger for demo purposes if firebase fails
                            const email = prompt("Email:");
                            const pass = prompt("Password:");
                            firebase.auth().signInWithEmailAndPassword(email, pass).catch(e => alert(e.message));
                        }} className="w-full py-3 bg-gradient-to-r from-inf-purple to-pink-600 rounded-xl font-bold text-white hover:scale-[1.02] transition">INICIAR SESIÓN</button>
                    </div>
                </div>
            );

            return (
                <div className="flex h-full w-full bg-inf-bg text-inf-text overflow-hidden">
                    <Sidebar tab={tab} setTab={setTab} onLogout={()=>firebase.auth().signOut()} />
                    <main className="flex-1 h-full overflow-hidden relative">
                        {tab === 'dashboard' && <DashboardView />}
                        {tab === 'studio' && <StudioView />}
                        {tab === 'chat' && <ChatView />}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
