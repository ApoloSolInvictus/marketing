<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INFINITI MKT | Creation Engine</title>
    
    <!-- Librerías -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        inf: {
                            bg: '#050505',
                            panel: '#111111',
                            purple: '#8b5cf6', // Primary
                            pink: '#ec4899',   // Accent
                            cyan: '#06b6d4',   // Tech
                            text: '#f3f4f6',
                            border: '#27272a'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #050505; color: #f3f4f6; overflow: hidden; }
        .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }
        .prose h1, .prose h2, .prose h3 { color: white; font-weight: bold; margin-bottom: 0.5rem; margin-top: 1rem; }
        .prose strong { color: #8b5cf6; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; color: #d1d5db; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #8b5cf6; }
    </style>
</head>
<body class="h-screen w-screen flex font-sans">
    <div id="root" class="w-full h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==========================================
        // CONFIGURACIÓN NEURONAL
        // ==========================================
        // Asegúrese de que esta URL sea la de su backend actualizado
        const API_URL = "https://marketing-ia-dca462ac6c86.herokuapp.com"; 

        const firebaseConfig = {
            apiKey: "AIzaSyDNSg33pfmXx4yPdsr_u6-tX7pukAQbvn4", 
            authDomain: "pits-382a0.firebaseapp.com",
            projectId: "pits-382a0",
            storageBucket: "pits-382a0.firebasestorage.app",
            messagingSenderId: "828002449733",
            appId: "1:828002449733:web:69a5738bab59a3c52ce62c"
        };

        try {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        } catch(e) { console.error("Firebase Error:", e); }

        // ==========================================
        // COMPONENTES DE INTERFAZ
        // ==========================================

        const Sidebar = ({ tab, setTab, onLogout }) => (
            <aside className="w-20 md:w-64 bg-inf-panel border-r border-inf-border flex flex-col transition-all duration-300 z-20">
                <div className="h-20 flex items-center justify-center md:justify-start md:px-6 border-b border-inf-border">
                    <i className="ph ph-infinity text-3xl text-inf-purple mr-0 md:mr-3 animate-pulse-slow"></i>
                    <span className="font-bold text-xl tracking-wider hidden md:block">INFINITI</span>
                </div>

                <nav className="flex-1 py-6 space-y-2 px-2">
                    <MenuBtn icon="ph-paint-brush-broad" label="Creative Studio" active={tab==='studio'} onClick={()=>setTab('studio')} />
                    <MenuBtn icon="ph-strategy" label="Estratega GPT" active={tab==='chat'} onClick={()=>setTab('chat')} />
                </nav>

                <div className="p-4 border-t border-inf-border">
                    <button onClick={onLogout} className="flex items-center justify-center md:justify-start w-full text-gray-500 hover:text-red-400 transition gap-3 p-2 rounded-lg hover:bg-white/5">
                        <i className="ph ph-sign-out text-xl"></i>
                        <span className="hidden md:block text-sm font-medium">Desconectar</span>
                    </button>
                </div>
            </aside>
        );

        const MenuBtn = ({ icon, label, active, onClick }) => (
            <button onClick={onClick} className={`w-full flex items-center justify-center md:justify-start gap-3 px-3 py-3 rounded-xl transition-all duration-200 ${active ? 'bg-gradient-to-r from-inf-purple to-indigo-600 text-white shadow-lg shadow-purple-500/20' : 'text-gray-400 hover:text-white hover:bg-white/5'}`}>
                <i className={`ph ${icon} text-xl`}></i>
                <span className="hidden md:block text-sm font-medium">{label}</span>
            </button>
        );

        // --- VISTA 1: CREATIVE STUDIO (TEXTO + IMAGEN + UPLOAD) ---
        const StudioView = () => {
            const [mode, setMode] = useState('text'); // 'text' | 'image'
            const [prompt, setPrompt] = useState('');
            const [result, setResult] = useState(null);
            const [loading, setLoading] = useState(false);
            const [uploadedImage, setUploadedImage] = useState(null); // Base64 image

            // Manejo de subida de imagen
            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setUploadedImage(reader.result); // Guardar base64
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleCreate = async () => {
                if(!prompt.trim() && !uploadedImage) return;
                setLoading(true);
                setResult(null);

                try {
                    const endpoint = mode === 'text' ? '/api/chat' : '/api/image';
                    
                    let payload = {};
                    
                    if (mode === 'text') {
                        payload = { 
                            message: `ACTÚA COMO: Copywriter experto. CREA: Contenido de marketing sobre "${prompt}". FORMATO: Markdown.`, 
                            history: [] 
                        };
                    } else {
                        // Modo Imagen: Enviamos el prompt y la imagen de referencia si existe
                        payload = { 
                            prompt: prompt,
                            reference_image: uploadedImage // Enviamos el base64 al backend
                        };
                    }

                    const res = await fetch(`${API_URL}${endpoint}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!res.ok) throw new Error("Error en el servidor");

                    const data = await res.json();
                    
                    if (mode === 'text') setResult(data.response);
                    else setResult({ url: data.url, enhanced: data.enhanced_prompt });

                } catch (e) {
                    alert("Error creativo: " + e.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="flex flex-col h-full p-8 gap-6 animate-fade-in">
                    <div className="glass p-6 rounded-2xl border border-inf-border flex flex-col md:flex-row gap-6 h-full">
                        
                        {/* LEFT PANEL: CONTROLS */}
                        <div className="w-full md:w-1/3 flex flex-col gap-4">
                            <h2 className="font-bold text-white mb-2 flex items-center gap-2"><i className="ph ph-lightning text-inf-purple"></i> Panel de Control</h2>
                            
                            <div className="flex bg-black rounded-lg p-1 border border-inf-border">
                                <button onClick={()=>setMode('text')} className={`flex-1 py-2 text-xs font-bold rounded-md transition ${mode==='text' ? 'bg-inf-purple text-white' : 'text-gray-500 hover:text-white'}`}>TEXTO</button>
                                <button onClick={()=>setMode('image')} className={`flex-1 py-2 text-xs font-bold rounded-md transition ${mode==='image' ? 'bg-inf-pink text-white' : 'text-gray-500 hover:text-white'}`}>IMAGEN</button>
                            </div>

                            {/* UPLOAD ZONE (Solo visible en modo imagen) */}
                            {mode === 'image' && (
                                <div className="border-2 border-dashed border-inf-border rounded-xl p-4 text-center hover:border-inf-pink/50 transition relative group cursor-pointer bg-black/20">
                                    <input type="file" accept="image/*" onChange={handleImageUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                    {uploadedImage ? (
                                        <div className="relative">
                                            <img src={uploadedImage} className="h-24 mx-auto rounded border border-inf-border object-cover" />
                                            <button onClick={(e)=>{e.preventDefault(); setUploadedImage(null);}} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs"><i className="ph ph-x"></i></button>
                                        </div>
                                    ) : (
                                        <div className="text-gray-500 group-hover:text-inf-pink transition">
                                            <i className="ph ph-upload-simple text-2xl mb-1"></i>
                                            <p className="text-[10px] font-bold uppercase">Subir Referencia (Opcional)</p>
                                        </div>
                                    )}
                                </div>
                            )}

                            <textarea 
                                value={prompt} onChange={e=>setPrompt(e.target.value)}
                                className="flex-1 bg-black/50 border border-inf-border rounded-xl p-4 text-white focus:border-inf-purple outline-none resize-none placeholder:text-gray-600 text-sm"
                                placeholder={mode === 'text' ? "Describe el post..." : "Describe la imagen que deseas..."}
                            ></textarea>
                            
                            <button onClick={handleCreate} disabled={loading} className={`w-full py-3 rounded-xl font-bold text-white shadow-lg transition flex justify-center items-center gap-2 transform active:scale-95 ${mode==='text' ? 'bg-inf-purple hover:bg-purple-600' : 'bg-inf-pink hover:bg-pink-600'}`}>
                                {loading ? <i className="ph ph-spinner animate-spin"></i> : <i className="ph ph-sparkle"></i>}
                                {mode === 'text' ? 'Generar Copy' : 'Generar Arte'}
                            </button>
                        </div>

                        {/* RIGHT PANEL: RESULT */}
                        <div className="flex-1 bg-black/30 rounded-xl border border-inf-border p-6 overflow-y-auto flex items-center justify-center relative min-h-[400px]">
                            {!result && !loading && (
                                <div className="text-center opacity-30">
                                    <i className={`ph ${mode==='text' ? 'ph-pencil-simple' : 'ph-image'} text-6xl mb-2`}></i>
                                    <p>El lienzo está vacío</p>
                                </div>
                            )}
                            {loading && (
                                <div className="text-center">
                                    <div className="w-12 h-12 border-4 border-white border-t-transparent rounded-full animate-spin mb-4 mx-auto"></div>
                                    <p className="text-xs text-inf-cyan animate-pulse">{mode === 'text' ? 'Redactando...' : (uploadedImage ? 'Analizando referencia y pintando...' : 'Renderizando Arte...')}</p>
                                </div>
                            )}
                            {result && mode === 'text' && (
                                <div className="prose prose-invert w-full text-left" dangerouslySetInnerHTML={{__html: marked.parse(result)}}></div>
                            )}
                            {result && mode === 'image' && (
                                <div className="text-center w-full h-full flex flex-col items-center justify-center">
                                    <img src={result.url} className="max-h-full max-w-full rounded-lg shadow-2xl border border-inf-border object-contain" />
                                    <div className="mt-4 flex gap-4">
                                        <a href={result.url} target="_blank" download className="px-6 py-2 bg-white text-black rounded-full font-bold text-xs hover:bg-gray-200 transition flex items-center gap-2"><i className="ph ph-download"></i> Descargar HD</a>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- VISTA 2: CHAT GPT ---
        const ChatView = () => {
            const [messages, setMessages] = useState([{ role: 'ai', content: 'Hola. Soy tu Estratega de Marketing Senior. ¿Qué campaña planeamos hoy?' }]);
            const [input, setInput] = useState("");
            const [loading, setLoading] = useState(false);
            const bottomRef = useRef(null);

            useEffect(() => bottomRef.current?.scrollIntoView({ behavior: 'smooth' }), [messages]);

            const send = async () => {
                if(!input.trim()) return;
                const newMsg = { role: 'user', content: input };
                setMessages(p => [...p, newMsg]);
                setInput(""); setLoading(true);

                try {
                    const res = await fetch(`${API_URL}/api/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: newMsg.content, history: messages })
                    });
                    const data = await res.json();
                    setMessages(p => [...p, { role: 'ai', content: data.response }]);
                } catch(e) {
                    setMessages(p => [...p, { role: 'ai', content: "Error de conexión." }]);
                } finally { setLoading(false); }
            };

            return (
                <div className="flex flex-col h-full bg-inf-bg">
                    <div className="flex-1 overflow-y-auto p-8 space-y-6">
                        {messages.map((m, i) => (
                            <div key={i} className={`flex ${m.role==='user'?'justify-end':'justify-start'}`}>
                                <div className={`max-w-[80%] p-4 rounded-2xl text-sm leading-relaxed shadow-lg ${m.role==='user'?'bg-inf-purple text-white rounded-br-none':'bg-inf-panel border border-inf-border text-gray-300 rounded-bl-none'}`}>
                                    <div dangerouslySetInnerHTML={{__html: marked.parse(m.content)}}></div>
                                </div>
                            </div>
                        ))}
                        {loading && <div className="text-gray-500 text-xs ml-4">Escribiendo estrategia...</div>}
                        <div ref={bottomRef}></div>
                    </div>
                    <div className="p-6 border-t border-inf-border bg-inf-panel">
                        <div className="flex gap-2 max-w-4xl mx-auto">
                            <input type="text" value={input} onChange={e=>setInput(e.target.value)} onKeyPress={e=>e.key==='Enter' && send()} className="flex-1 bg-black/50 border border-inf-border rounded-xl px-4 text-white focus:border-inf-purple outline-none" placeholder="Escribe tu consulta..." />
                            <button onClick={send} className="p-3 bg-inf-purple rounded-xl text-white hover:bg-purple-600 transition"><i className="ph ph-paper-plane-right"></i></button>
                        </div>
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onLogin }) => {
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const handleLogin = (e) => { e.preventDefault(); onLogin({ email: email || 'admin@infiniti.com' }); };
            return (
                <div className="w-full h-full flex items-center justify-center bg-mkt-dark relative">
                    <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-20"></div>
                    <div className="w-[500px] h-[500px] bg-inf-purple/20 rounded-full blur-[100px] absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"></div>
                    
                    <div className="bg-inf-panel p-10 rounded-2xl border border-inf-border shadow-2xl w-full max-w-md relative z-10 fade-in backdrop-blur-xl">
                        <div className="text-center mb-8">
                            <i className="ph ph-rocket-launch text-5xl text-inf-purple mb-4"></i>
                            <h1 className="text-3xl font-bold text-white tracking-wide">INFINITI <span className="text-inf-purple">MKT</span></h1>
                            <p className="text-xs text-gray-400 uppercase tracking-widest mt-2">Marketing OS</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-5">
                            <input type="email" value={email} onChange={e=>setEmail(e.target.value)} className="w-full bg-black/50 border border-inf-border rounded-lg p-4 text-white outline-none focus:border-inf-purple transition" placeholder="Email Agente" />
                            <input type="password" value={password} onChange={e=>setPassword(e.target.value)} className="w-full bg-black/50 border border-inf-border rounded-lg p-4 text-white outline-none focus:border-inf-purple transition" placeholder="Clave Maestra" />
                            <button className="w-full py-4 bg-gradient-to-r from-inf-purple to-pink-600 hover:to-purple-500 text-white font-bold rounded-lg transition shadow-lg transform hover:scale-[1.02]">
                                INICIAR SISTEMA
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [tab, setTab] = useState('studio'); 
            useEffect(() => { firebase.auth().onAuthStateChanged(u => setUser(u || null)); }, []);
            return <React.Fragment>{!user ? <LoginScreen onLogin={setUser} /> : 
                <div className="flex h-full w-full bg-inf-bg text-inf-text overflow-hidden">
                    <Sidebar tab={tab} setTab={setTab} onLogout={()=>firebase.auth().signOut()} />
                    <main className="flex-1 h-full overflow-hidden relative">
                        {tab === 'studio' && <StudioView />}
                        {tab === 'chat' && <ChatView />}
                    </main>
                </div>
            }</React.Fragment>;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

